<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>APK 分析系统</title>
    <!-- Bootstrap CSS -->
    <link href="https://cdn.bootcdn.net/ajax/libs/twitter-bootstrap/5.1.3/css/bootstrap.min.css" rel="stylesheet">
    <!-- Font Awesome -->
    <link href="https://cdn.bootcdn.net/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.socket.io/4.0.0/socket.io.min.js"></script>
    
    <style>
        body {
            background-color: #f8f9fa;
        }
        .container {
            max-width: 800px;
            margin-top: 2rem;
        }
        .card {
            border-radius: 15px;
            box-shadow: 0 0 20px rgba(0,0,0,0.1);
        }
        .message-box {
            height: 300px;
            overflow-y: auto;
            background-color: #f8f9fa;
            border-radius: 10px;
            padding: 1rem;
            font-family: monospace;
        }
        .btn-upload {
            position: relative;
            overflow: hidden;
        }
        .btn-upload input[type=file] {
            position: absolute;
            top: 0;
            right: 0;
            min-width: 100%;
            min-height: 100%;
            font-size: 100px;
            text-align: right;
            opacity: 0;
            outline: none;
            cursor: pointer;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="card">
            <div class="card-header bg-primary text-white text-center py-3">
                <h3 class="mb-0"><i class="fas fa-mobile-alt me-2"></i>APK 分析系统</h3>
            </div>
            <div class="card-body">
                <form id="uploadForm" class="mb-4">
                    <div class="row g-3 align-items-center">
                        <div class="col-auto">
                            <div class="btn btn-outline-primary btn-upload">
                                <i class="fas fa-file-upload me-2"></i>选择 APK 文件
                                <input type="file" name="file" accept=".apk">
                            </div>
                        </div>
                        <div class="col">
                            <button type="button" id="uploadButton" class="btn btn-primary">
                                <i class="fas fa-cloud-upload-alt me-2"></i>上传
                            </button>
                        </div>
                    </div>
                </form>

                <div class="d-grid gap-2 d-md-flex justify-content-md-start mb-4">
                    <button type="button" id="startButton" class="btn btn-success">
                        <i class="fas fa-play me-2"></i>开始分析
                    </button>
                    <button type="button" id="displayButton" class="btn btn-info text-white">
                        <i class="fas fa-chart-bar me-2"></i>显示结果
                    </button>
                </div>

                <div class="card">
                    <div class="card-header bg-light">
                        <h5 class="mb-0"><i class="fas fa-terminal me-2"></i>分析日志</h5>
                    </div>
                    <div class="card-body">
                        <pre id="messageBox" class="message-box"></pre>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Bootstrap Bundle with Popper -->
    <script src="https://cdn.bootcdn.net/ajax/libs/twitter-bootstrap/5.1.3/js/bootstrap.bundle.min.js"></script>
    
    <script type="text/javascript">
        document.addEventListener('DOMContentLoaded', (event) => {
            var socket = io.connect(location.protocol + '//' + document.domain + ':' + location.port + '/test');

            socket.on('my_event', (msg) => {
                console.log(msg);
                var messageBox = document.getElementById('messageBox');
                const time = new Date().toLocaleTimeString();
                messageBox.innerHTML += `[${time}] ${JSON.stringify(msg)}\n`;
                messageBox.scrollTop = messageBox.scrollHeight;
                
                if (msg.msg === 'successfully produce out file, please press display button') {
                    showToast('分析完成！请点击"显示结果"按钮查看分析结果。');
                }
            });

            function showToast(message) {
                const toastContainer = document.createElement('div');
                toastContainer.style.position = 'fixed';
                toastContainer.style.top = '20px';
                toastContainer.style.right = '20px';
                toastContainer.style.zIndex = '1050';
                
                toastContainer.innerHTML = `
                    <div class="toast show" role="alert">
                        <div class="toast-header">
                            <strong class="me-auto">系统提示</strong>
                            <button type="button" class="btn-close" data-bs-dismiss="toast"></button>
                        </div>
                        <div class="toast-body">${message}</div>
                    </div>
                `;
                
                document.body.appendChild(toastContainer);
                setTimeout(() => toastContainer.remove(), 3000);
            }

            function startAnalysis() {
                fetch('/start', {method: 'GET'})
                    .then(response => response.text())
                    .then(data => console.log(data));
            }

            function uploadAPK() {
                var formData = new FormData(document.getElementById('uploadForm'));
                fetch('/upload_apk', {
                    method: 'POST',
                    body: formData
                })
                .then(response => response.text())
                .then(data => {
                    console.log(data);
                    if(data === 'success') {
                        showToast('APK 上传成功！');
                    }
                });
            }

            function displayResults() {
                window.location.href = '/display';
            }

            document.getElementById('startButton').addEventListener('click', startAnalysis);
            document.getElementById('uploadButton').addEventListener('click', uploadAPK);
            document.getElementById('displayButton').addEventListener('click', displayResults);
        });
    </script>
</body>
</html>


